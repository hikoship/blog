<!doctype html><html><head><meta charset=utf-8><meta name=generator content="Hugo 0.151.0"><meta name=keywords content="the great garage,hiko,hikoship,blog"><meta name=description content><meta name=author content="hiko, hikoship"><meta name=viewport content="width=device-width,initial-scale=1"><link href='https://fonts.googleapis.com/css?family=Lato:100,300,400,600' rel=stylesheet type=text/css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/normalize/3.0.3/normalize.min.css><link rel=stylesheet href=/css/main.css><link rel=stylesheet href=/css/pygments.css><link rel=icon type=image/png href=images/favicon.png><script>(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)})(window,document,"script","//www.google-analytics.com/analytics.js","ga"),ga("create","UA-55878990-3","auto"),ga("send","pageview")</script><title>Hugo, GitHub, VPS (2): Write a Hook Listener and Protect It Using Supervisor - The Great Garage</title></head><body><div class=container><header align=center class=nav><div id=top-bar></div><a href=/><img id=img-title src=/images/logo.png alt="The Great Garage - Logo"></a><div class=row><div class="twelve columns" style=margin-top:0><a href=/post>Posts</a><span class=divider> ✢ </span><a href=/categories>Categories</a><span class=divider> ✢ </span><a href=/collection>Collection</a><span class=divider> ✢ </span><a href=/about>About</a></div></div></header><main role=main><article><header class=meta align=center><h2>Hugo, GitHub, VPS (2): Write a Hook Listener and Protect It Using Supervisor</h2></header><div class=content><p>The article will talk about the first part mentioned in <em><a href=/post/hugo-github-vps-1/>Hugo, GitHub, VPS (1): A Work Flow for static sites</a></em>.</p><h2 id=create-github-webhooks>Create GitHub webhooks</h2><p>GitHub has an <a href=https://developer.github.com/webhooks/>official tutorial</a> for webhooks, you can follow it and create one easily. The tutorial sets the payload URL to <code>http://localhost:4567/payload</code>, but since my hook is deployed on the VPS, I just fill in <code>http://my.domain:18001</code>. The port <code>:4567</code> and the subfolder <code>payload</code> doesn&rsquo;t matter. That&rsquo;s where the <em>POST</em> request is sent, and you just need to match it with the port and location of your hook. I preserve the whole <code>:18001</code> port for the hook, so I let the request sent to the root path directly.</p><p>The content type is <code>application/json</code>, and we only trigger the hook for push events.</p><h2 id=write-a-hook-listener>Write a hook listener</h2><p>The tutorial offers a sample listener app written in <a href=http://www.sinatrarb.com>Sinatra</a>, which is a Ruby micro-framework. Unfortunately, I know little about Ruby as well as Sinatra, so I choose to use <a href=http://www.tornadoweb.org>Tornado</a>, a Python framework.</p><p>There is a <a href=http://www.tornadoweb.org/en/stable/#hello-world>&ldquo;Hello, world&rdquo; example</a> in Tornado&rsquo;s documents. It has a <code>get</code> method in <code>MainHandler</code>, and what we want is a <code>post</code> method. So delete <code>get</code> and write a <code>post</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=ln>1</span><span class=cl><span class=kn>import</span> <span class=nn>sys</span><span class=o>,</span> <span class=nn>subprocess</span>
</span></span><span class=line><span class=ln>2</span><span class=cl>
</span></span><span class=line><span class=ln>3</span><span class=cl><span class=k>class</span> <span class=nc>MainHandler</span><span class=p>(</span><span class=n>tornado</span><span class=o>.</span><span class=n>web</span><span class=o>.</span><span class=n>RequestHandler</span><span class=p>):</span>
</span></span><span class=line><span class=ln>4</span><span class=cl>    <span class=k>def</span> <span class=nf>post</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=ln>5</span><span class=cl>        <span class=c1># do something</span>
</span></span><span class=line><span class=ln>6</span><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;New POST Received.&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=ln>7</span><span class=cl>        <span class=n>subprocess</span><span class=o>.</span><span class=n>call</span><span class=p>([</span><span class=n>sys</span><span class=o>.</span><span class=n>path</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>+</span> <span class=s2>&#34;/generate.sh&#34;</span><span class=p>])</span></span></span></code></pre></div><p>Now, you can run the app and push something to your blog for which a hook has been set, and the terminal will show <code>New POST Received.</code>. Then, it executes a shell script called <code>generate.sh</code>, which is located in the same folder as the tornado python file. Since we want our VPS to pull down the new source codes immediately and regenerate the static site, so we embed these operations in the script file and make it look like this:</p><pre tabindex=0><code>#! /bin/sh

cd path/to/blog-repo
git pull
rm -rf public # remove previous output files
hugo # generate the site in public/
</code></pre><p>Then change its authority:</p><pre tabindex=0><code>chmod +x generate.sh
</code></pre><p>Next, we judge whether the <em>POST</em> request is from our GitHub repository. Perhaps the hook is listening to several updates from different users, branches and repos, so let&rsquo;s parse the <em>json</em> file and read its information.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=ln> 1</span><span class=cl><span class=kn>import</span> <span class=nn>json</span>
</span></span><span class=line><span class=ln> 2</span><span class=cl><span class=kn>import</span> <span class=nn>sys</span><span class=o>,</span> <span class=nn>subprocess</span>
</span></span><span class=line><span class=ln> 3</span><span class=cl>
</span></span><span class=line><span class=ln> 4</span><span class=cl><span class=k>class</span> <span class=nc>MainHandler</span><span class=p>(</span><span class=n>tornado</span><span class=o>.</span><span class=n>web</span><span class=o>.</span><span class=n>RequestHandler</span><span class=p>):</span>
</span></span><span class=line><span class=ln> 5</span><span class=cl>    <span class=k>def</span> <span class=nf>post</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=ln> 6</span><span class=cl>        <span class=n>data</span> <span class=o>=</span> <span class=n>json</span><span class=o>.</span><span class=n>loads</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>request</span><span class=o>.</span><span class=n>body</span><span class=p>)</span>
</span></span><span class=line><span class=ln> 7</span><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=ln> 8</span><span class=cl>            <span class=n>repo</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;repository&#39;</span><span class=p>][</span><span class=s1>&#39;full_name&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=ln> 9</span><span class=cl>        <span class=k>except</span> <span class=ne>KeyError</span><span class=p>:</span>
</span></span><span class=line><span class=ln>10</span><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;Not a GitHub webhook post&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=ln>11</span><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=ln>12</span><span class=cl>            <span class=k>if</span> <span class=n>repo</span> <span class=o>==</span> <span class=s1>&#39;yourusername/yourreponame&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=ln>13</span><span class=cl>                <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;POST from my blog&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=ln>14</span><span class=cl>                <span class=n>subprocess</span><span class=o>.</span><span class=n>call</span><span class=p>([</span><span class=n>sys</span><span class=o>.</span><span class=n>path</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>+</span> <span class=s2>&#34;/generate.sh&#34;</span><span class=p>])</span>
</span></span><span class=line><span class=ln>15</span><span class=cl>            <span class=k>elif</span> <span class=n>repo</span> <span class=o>==</span> <span class=s1>&#39;user2/repo2&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=ln>16</span><span class=cl>                <span class=c1># do something...</span>
</span></span><span class=line><span class=ln>17</span><span class=cl>            <span class=k>elif</span> <span class=n>repo</span> <span class=o>==</span> <span class=s1>&#39;user3/repo3&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=ln>18</span><span class=cl>                <span class=c1># do something...</span>
</span></span><span class=line><span class=ln>19</span><span class=cl>            <span class=k>elif</span> <span class=n>repo</span> <span class=o>==</span> <span class=s1>&#39;user4/repo4&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=ln>20</span><span class=cl>                <span class=c1># do something</span>
</span></span><span class=line><span class=ln>21</span><span class=cl>
</span></span><span class=line><span class=ln>22</span><span class=cl><span class=n>const</span> <span class=n>uint16_t</span> <span class=n>PROGMEM</span> <span class=n>keymaps</span><span class=p>[][</span><span class=n>MATRIX_ROWS</span><span class=p>][</span><span class=n>MATRIX_COLS</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>23</span><span class=cl>    <span class=o>//</span> <span class=n>Your</span> <span class=n>configuration</span>
</span></span><span class=line><span class=ln>24</span><span class=cl><span class=p>}</span></span></span></code></pre></div><p>Finally, we add logging module and filter IP addresses outside GitHub to prevent potentially harmful pseudo <em>POST</em> requests. Luckily, GitHub has <a href=https://help.github.com/articles/what-ip-addresses-does-github-use-that-i-should-whitelist/>a whitelist</a>, so we only allow addresses from <code>192.30.252/22</code>. Now we&rsquo;ve got the whole program:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=ln> 1</span><span class=cl><span class=kn>import</span> <span class=nn>tornado.ioloop</span><span class=o>,</span> <span class=nn>tornado.web</span>
</span></span><span class=line><span class=ln> 2</span><span class=cl><span class=kn>import</span> <span class=nn>json</span>
</span></span><span class=line><span class=ln> 3</span><span class=cl><span class=kn>import</span> <span class=nn>os</span><span class=o>,</span> <span class=nn>sys</span><span class=o>,</span> <span class=nn>logging</span><span class=o>,</span> <span class=nn>subprocess</span>
</span></span><span class=line><span class=ln> 4</span><span class=cl>
</span></span><span class=line><span class=ln> 5</span><span class=cl><span class=k>class</span> <span class=nc>MainHandler</span><span class=p>(</span><span class=n>tornado</span><span class=o>.</span><span class=n>web</span><span class=o>.</span><span class=n>RequestHandler</span><span class=p>):</span>
</span></span><span class=line><span class=ln> 6</span><span class=cl>    <span class=k>def</span> <span class=nf>post</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=ln> 7</span><span class=cl>        <span class=n>data</span> <span class=o>=</span> <span class=n>json</span><span class=o>.</span><span class=n>loads</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>request</span><span class=o>.</span><span class=n>body</span><span class=p>)</span>
</span></span><span class=line><span class=ln> 8</span><span class=cl>        <span class=n>ip</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>request</span><span class=o>.</span><span class=n>remote_ip</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s1>&#39;.&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=ln> 9</span><span class=cl>        <span class=k>if</span> <span class=n>ip</span><span class=p>[:</span><span class=mi>2</span><span class=p>]</span> <span class=o>==</span> <span class=p>[</span><span class=s1>&#39;192&#39;</span><span class=p>,</span> <span class=s1>&#39;30&#39;</span><span class=p>]</span> <span class=ow>and</span> <span class=nb>int</span><span class=p>(</span><span class=n>ip</span><span class=p>[</span><span class=mi>2</span><span class=p>])</span> <span class=o>&gt;=</span> <span class=mi>252</span><span class=p>:</span>
</span></span><span class=line><span class=ln>10</span><span class=cl>            <span class=c1>## GitHub IP range</span>
</span></span><span class=line><span class=ln>11</span><span class=cl>            <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=ln>12</span><span class=cl>                <span class=n>repo</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=s1>&#39;repository&#39;</span><span class=p>][</span><span class=s1>&#39;full_name&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=ln>13</span><span class=cl>            <span class=k>except</span> <span class=ne>KeyError</span><span class=p>:</span>
</span></span><span class=line><span class=ln>14</span><span class=cl>                <span class=n>logging</span><span class=o>.</span><span class=n>warning</span><span class=p>(</span><span class=s1>&#39;Not a GitHub webhook post&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=ln>15</span><span class=cl>            <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=ln>16</span><span class=cl>                <span class=k>if</span> <span class=n>repo</span> <span class=o>==</span> <span class=s1>&#39;yourusername/yourreponame&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=ln>17</span><span class=cl>                    <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;POST from my blog&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=ln>18</span><span class=cl>                    <span class=n>subprocess</span><span class=o>.</span><span class=n>call</span><span class=p>([</span><span class=n>sys</span><span class=o>.</span><span class=n>path</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>+</span> <span class=s2>&#34;/generate.sh&#34;</span><span class=p>])</span>
</span></span><span class=line><span class=ln>19</span><span class=cl>                <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=ln>20</span><span class=cl>                    <span class=n>logging</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s1>&#39;Unknown repo: </span><span class=si>%s</span><span class=s1>&#39;</span><span class=p>,</span> <span class=n>repo</span><span class=p>)</span>
</span></span><span class=line><span class=ln>21</span><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=ln>22</span><span class=cl>            <span class=n>logging</span><span class=o>.</span><span class=n>warning</span><span class=p>(</span><span class=s1>&#39;Not from GitHub. IP [</span><span class=si>%s</span><span class=s1>]: </span><span class=si>%s</span><span class=s1>&#39;</span><span class=p>,</span> <span class=n>ip</span><span class=p>,</span> <span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=ln>23</span><span class=cl>
</span></span><span class=line><span class=ln>24</span><span class=cl><span class=k>def</span> <span class=nf>make_app</span><span class=p>():</span>
</span></span><span class=line><span class=ln>25</span><span class=cl>    <span class=k>return</span> <span class=n>tornado</span><span class=o>.</span><span class=n>web</span><span class=o>.</span><span class=n>Application</span><span class=p>([</span>
</span></span><span class=line><span class=ln>26</span><span class=cl>        <span class=p>(</span><span class=sa>r</span><span class=s2>&#34;/&#34;</span><span class=p>,</span> <span class=n>MainHandler</span><span class=p>),</span> <span class=c1># match your payload URL</span>
</span></span><span class=line><span class=ln>27</span><span class=cl>    <span class=p>])</span>
</span></span><span class=line><span class=ln>28</span><span class=cl>
</span></span><span class=line><span class=ln>29</span><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=ln>30</span><span class=cl>    <span class=n>logging</span><span class=o>.</span><span class=n>basicConfig</span><span class=p>(</span><span class=nb>format</span><span class=o>=</span><span class=s1>&#39;</span><span class=si>%(asctime)s</span><span class=s1> </span><span class=si>%(message)s</span><span class=s1>&#39;</span><span class=p>,</span> <span class=n>datefmt</span><span class=o>=</span><span class=s1>&#39;%m/</span><span class=si>%d</span><span class=s1>/%Y, </span><span class=si>%a</span><span class=s1>, %H:%M:%S&#39;</span><span class=p>,</span> <span class=n>filename</span><span class=o>=</span><span class=n>sys</span><span class=o>.</span><span class=n>path</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>+</span> <span class=s1>&#39;/post.log&#39;</span><span class=p>,</span><span class=n>level</span><span class=o>=</span><span class=n>logging</span><span class=o>.</span><span class=n>INFO</span><span class=p>)</span>
</span></span><span class=line><span class=ln>31</span><span class=cl>    <span class=n>app</span> <span class=o>=</span> <span class=n>make_app</span><span class=p>()</span>
</span></span><span class=line><span class=ln>32</span><span class=cl>    <span class=n>app</span><span class=o>.</span><span class=n>listen</span><span class=p>(</span><span class=mi>18001</span><span class=p>)</span> <span class=c1># match your payload URL</span>
</span></span><span class=line><span class=ln>33</span><span class=cl>    <span class=n>tornado</span><span class=o>.</span><span class=n>ioloop</span><span class=o>.</span><span class=n>IOLoop</span><span class=o>.</span><span class=n>current</span><span class=p>()</span><span class=o>.</span><span class=n>start</span><span class=p>()</span></span></span></code></pre></div><h2 id=protect-the-listener-process>Protect the listener process</h2><p>In order to let our listener process run consistently in background and reboot after crash, we use <a href=http://supervisord.org/>Supervisor</a> as a daemon program. Besides, it can manage multiple subprocesses of a tornado app and balance the load with the help of <a href=http://nginx.org/>nginx</a>, but it&rsquo;s unnecessary for a simple hook.</p><p>Follow <a href=http://supervisord.org/configuration.html>this direction</a> to put your <code>supervisord.conf</code> file in proper path, and add codes like the following:</p><pre tabindex=0><code>[program:mylistener]
command=python /path/to/mylistener.py
redirect_stderr=true
stdout_logfile=/path/to/log.log
</code></pre><p>Then, run <code>supervisorctl reload</code> to check if <code>mylistener</code> has been started.</p><h2 id=host-the-blog>Host the blog</h2><p>Almost all static site generators have their internal server, but you can also use more dedicated web servers such as Apache or nginx for advanced performance and stability, just setting the host path to your output folder in the configuration file.</p><p>We are done! Now try pushing something on GitHub, and you should see changes on your VPS.</p></div></article><hr><div id=disqus_thread></div><script type=text/javascript>var disqus_shortname="gaohongyuan";(function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="//"+disqus_shortname+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)})()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript rel=nofollow>comments powered by Disqus.</a></noscript></main></div><footer class=footer><div align=center>Favorites・
<a href=http://gaocegege.com/Blog/ target=_blank>高策</a> |
<a href=https://dlyang.me/>LanternD</a> |<br>&copy; 2015 - 2025 <a href=http://hgao.net target=_blank>HiKo</a><br>Powered by <a href=http://gohugo.io/ target=_blank>Hugo</a> ・ Hosted on <a href=https://github.com/hikoship/blog target=_blank>GitHub</a></div></footer></body></html>